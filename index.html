<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CalfNote 子牛管理</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root {
            --primary-color: #007bff; /* 青 */
            --secondary-color: #6c757d; /* 灰色 */
            --danger-color: #dc3545; /* 赤 */
            --warning-color: #ffc107; /* 黄色 */
            --success-color: #28a745; /* 緑 */
            --light-gray: #f0f2f5;
            --text-color: #333;
            --white-color: #fff;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0 0 70px 0; /* フッターナビゲーションのスペースを確保 */
            background-color: var(--light-gray);
            color: var(--text-color);
        }
        .page {
            display: none;
            padding: 15px;
        }
        .page.active {
            display: block;
        }
        h1, h2, h3 {
            margin: 0;
            padding: 0;
        }
        h1 {
            font-size: 1.4em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        h2 {
            font-size: 1.2em;
            margin: 20px 0 15px 0;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 5px;
        }
        .card {
            background-color: var(--white-color);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            padding: 18px; /* パディングを増やす */
            margin-bottom: 18px; /* マージンを増やす */
        }
        .button {
            display: block;
            width: 100%;
            padding: 14px; /* パディングを増やす */
            margin-top: 15px;
            border: none;
            border-radius: 8px;
            background-color: var(--primary-color);
            color: var(--white-color);
            font-size: 1.15em; /* フォントサイズを大きく */
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .button:hover {
            background-color: #0056b3;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        .button-secondary {
            background-color: var(--secondary-color);
        }
        .button-secondary:hover {
            background-color: #545b62;
        }
        .button-danger {
            background-color: var(--danger-color);
        }
        .button-danger:hover {
            background-color: #bd2130;
        }
        .button-small {
            padding: 9px 14px; /* パディングを調整 */
            font-size: 0.95em; /* フォントサイズを調整 */
            display: inline-block;
            width: auto;
            margin: 5px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px; /* マージンを増やす */
            font-weight: 600; /* 太字 */
            color: var(--text-color);
        }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="date"],
        .form-group select,
        .form-group textarea {
            width: calc(100% - 24px); /* パディング分を考慮 */
            padding: 12px; /* パディングを増やす */
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1em;
            box-sizing: border-box;
            background-color: var(--white-color);
            color: var(--text-color);
        }
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        .form-group input[type="radio"] {
            margin-right: 5px;
        }
        .radio-group label {
            display: inline-block;
            margin-right: 15px;
            font-weight: normal;
        }
        .list-item {
            background-color: var(--white-color);
            border-radius: 8px;
            padding: 18px; /* パディングを増やす */
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 5px solid transparent; /* ToDoリスト用 */
        }
        .list-item:last-child {
            margin-bottom: 0;
        }
        .list-item-content {
            flex-grow: 1;
        }
        .list-item-actions {
            margin-left: 10px;
            white-space: nowrap;
        }
        .list-item-title {
            font-weight: 600;
            font-size: 1.1em;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        .list-item-meta {
            font-size: 0.9em;
            color: var(--secondary-color);
        }
        .list-item.todo-urgent {
            border-left-color: var(--danger-color);
            background-color: #fff0f0; /* 薄い赤 */
        }
        .list-item.todo-warning {
            border-left-color: var(--warning-color);
            background-color: #fff9e6; /* 薄い黄 */
        }
        .todo-category-title {
            font-weight: bold;
            margin-top: 15px;
            margin-bottom: 10px;
            font-size: 1.1em;
            color: var(--primary-color);
        }
        .castration-status-buttons button {
            margin-right: 10px;
        }

        /* セリ予定の月見出し */
        .sale-month-header {
            font-weight: bold;
            font-size: 1.1em;
            margin-top: 20px;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ddd;
            color: var(--text-color);
        }
        .sale-item-indented {
            margin-left: 20px; /* インデント */
            font-size: 0.95em;
            color: var(--secondary-color);
            margin-bottom: 5px;
        }
        .sale-item-indented:last-child {
            margin-bottom: 0;
        }

        .nav {
            display: flex;
            justify-content: space-around;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--white-color);
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
            padding: 10px 0;
            z-index: 1000;
        }
        .nav-item {
            flex: 1;
            text-align: center;
            color: var(--secondary-color);
            text-decoration: none;
            font-size: 0.8em;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 5px 0;
        }
        .nav-item.active {
            color: var(--primary-color);
            font-weight: bold;
        }
        .nav-item-icon {
            font-size: 26px; /* アイコンサイズを大きく */
            height: 30px; /* アイコン高さを調整 */
            display: block;
            margin-bottom: 3px;
        }
        /* アイコンがfont-awesomeのclassであることを想定 */
        .fa-home:before { content: "\f015"; }
        .fa-list:before { content: "\f03a"; }
        .fa-plus-circle:before { content: "\f055"; }
        .fa-heartbeat:before { content: "\f21e"; }
        .fa-cog:before { content: "\f013"; }
        .hidden {
            display: none;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: var(--white-color);
            margin: auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        .error-message {
            color: var(--danger-color);
            font-size: 0.9em;
            margin-top: -10px;
            margin-bottom: 10px;
            display: none; /* 初期状態では非表示 */
        }
        .error-message.active {
            display: block;
        }
    </style>
</head>
<body>
    <div id="dashboardPage" class="page active">
        <h1>ダッシュボード</h1>
        <div class="card">
            <h2 style="margin-top: 0; border-bottom: none; padding-bottom: 0;">牛群サマリー</h2>
            <p>現在の総頭数: <span id="totalCows">0</span>頭</p>
            <p>オス: <span id="maleCows">0</span>頭, メス: <span id="femaleCows">0</span>頭</p>
            <p>平均月齢: <span id="averageAge">0</span>ヶ月</p>
        </div>

        <div class="card">
            <h2>ToDoリスト</h2>
            <div id="todoList">
                </div>
        </div>

        <div class="card">
            <h2>セリ予定</h2>
            <div id="saleScheduleList">
                </div>
        </div>
    </div>

    <div id="cowListPage" class="page">
        <h1>牛一覧</h1>
        <div class="card">
            <div class="form-group">
                <input type="text" id="cowSearchInput" placeholder="牛を検索...">
            </div>
            <div id="cowList">
                </div>
        </div>
    </div>

    <div id="addCowPage" class="page">
        <h1>新しい子牛を登録</h1>
        <div class="card">
            <form id="newCowForm">
                <div class="form-group">
                    <label for="cowName">個体名</label>
                    <input type="text" id="cowName" required>
                </div>
                <div class="form-group">
                    <label for="individualId">個体識別番号</label>
                    <input type="text" id="individualId" placeholder="耳標番号など">
                </div>
                <div class="form-group">
                    <label for="motherId">母牛番号</label>
                    <input type="text" id="motherId">
                </div>
                <div class="form-group">
                    <p class="error-message" id="id-error-message">個体識別番号か母牛番号のどちらかを入力してください。</p>
                </div>
                <div class="form-group">
                    <label for="birthDate">生年月日</label>
                    <input type="date" id="birthDate" required>
                </div>
                <div class="form-group">
                    <label>性別</label>
                    <div class="radio-group">
                        <input type="radio" id="sexMale" name="sex" value="オス" required>
                        <label for="sexMale">オス</label>
                        <input type="radio" id="sexFemale" name="sex" value="メス">
                        <label for="sexFemale">メス</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>出生時サイズ (1-5)</label>
                    <div class="radio-group">
                        <input type="radio" id="size-1" name="birthSize" value="1">
                        <label for="size-1">1: 小柄</label>
                        <input type="radio" id="size-2" name="birthSize" value="2">
                        <label for="size-2">2: やや小柄</label>
                        <input type="radio" id="size-3" name="birthSize" value="3" checked>
                        <label for="size-3">3: 標準</label>
                        <input type="radio" id="size-4" name="birthSize" value="4">
                        <label for="size-4">4: やや大柄</label>
                        <input type="radio" id="size-5" name="birthSize" value="5">
                        <label for="size-5">5: 大柄</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="birthWeight">出生時体重 (kg)</label>
                    <input type="number" id="birthWeight" step="0.1" min="0">
                </div>
                <div class="form-group">
                    <label for="birthMemo">出生時メモ</label>
                    <textarea id="birthMemo" rows="3"></textarea>
                </div>
                <button type="submit" class="button">子牛を登録</button>
            </form>
        </div>
    </div>

    <div id="healthManagementPage" class="page">
        <h1>健康管理</h1>
        <div class="card">
            <div class="form-group">
                <input type="text" id="healthSearchInput" placeholder="牛を検索...">
            </div>
            <div id="healthCowList">
                </div>
        </div>
    </div>

    <div id="cowDetailModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeCowDetailModal()">&times;</span>
            <h2 id="detailCowName"></h2>
            <div class="card">
                <h3 style="margin-top: 0;">基本情報</h3>
                <p>個体識別番号: <span id="view-individualId"></span> <button class="button-small" onclick="openEditModal('individualId')">編集</button></p>
                <p>母牛番号: <span id="view-motherId"></span> <button class="button-small" onclick="openEditModal('motherId')">編集</button></p>
                <p>生年月日: <span id="view-birthDate"></span> <button class="button-small" onclick="openEditModal('birthDate')">編集</button></p>
                <p>月齢: <span id="view-age"></span></p>
                <p>性別: <span id="view-sex"></span> <button class="button-small" onclick="openEditModal('sex')">編集</button></p>
                <p>出生時サイズ: <span id="view-birth-size"></span> <button class="button-small" onclick="openEditModal('birthSize')">編集</button></p>
                <p>出生時体重: <span id="view-birthWeight"></span>kg <button class="button-small" onclick="openEditModal('birthWeight')">編集</button></p>
                <p>出生時メモ: <span id="view-birthMemo"></span> <button class="button-small" onclick="openEditModal('birthMemo')">編集</button></p>
                <p>去勢: <span id="view-castrationStatus"></span></p>
                <div class="castration-status-buttons">
                    <button class="button-small button-secondary" id="castrateButton" onclick="updateCastrationStatus()">去勢済みにする</button>
                    <button class="button-small button-secondary" id="uncastrateButton" onclick="revertCastrationStatus()">未去勢に戻す</button>
                </div>
                <p>出荷ステータス: <span id="view-saleStatus"></span></p>
                <div id="saleInfo" class="hidden">
                    <p>出荷日: <span id="view-saleDate"></span></p>
                    <p>販売価格: <span id="view-salePrice"></span>円</p>
                    <p>出荷メモ: <span id="view-saleMemo"></span></p>
                </div>
                <button class="button" id="recordSaleButton">出荷情報を登録</button>
            </div>

            <div class="card">
                <h3>健康記録</h3>
                <div id="healthRecordsList">
                    </div>
                <button class="button" onclick="openAddHealthRecordModal()">新しい健康記録を追加</button>
            </div>

            <div class="card">
                <h3>ワクチン履歴</h3>
                <div id="vaccineHistoryList">
                    </div>
                <button class="button" onclick="openVaccineRecordModal()">ワクチン接種を記録</button>
            </div>

            <button class="button button-danger" onclick="deleteCow()">この子牛を削除</button>
        </div>
    </div>

    <div id="editFieldModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeEditModal()">&times;</span>
            <h2 id="editModalTitle"></h2>
            <div class="form-group" id="edit-individualId-group">
                <label for="edit-individualId">個体識別番号</label>
                <input type="text" id="edit-individualId">
            </div>
            <div class="form-group" id="edit-motherId-group">
                <label for="edit-motherId">母牛番号</label>
                <input type="text" id="edit-motherId">
            </div>
            <p class="error-message" id="edit-id-error-message">個体識別番号か母牛番号のどちらかを入力してください。</p>
            <div class="form-group" id="edit-birthDate-group">
                <label for="edit-birthDate">生年月日</label>
                <input type="date" id="edit-birthDate">
            </div>
            <div class="form-group" id="edit-sex-group">
                <label>性別</label>
                <div class="radio-group">
                    <input type="radio" id="edit-sexMale" name="edit-sex" value="オス">
                    <label for="edit-sexMale">オス</label>
                    <input type="radio" id="edit-sexFemale" name="edit-sex" value="メス">
                    <label for="edit-sexFemale">メス</label>
                </div>
            </div>
            <div class="form-group" id="edit-birth-size-group">
                <label>出生時サイズ (1-5)</label>
                <div class="radio-group">
                    <input type="radio" id="edit-size-1" name="edit-birthSize" value="1">
                    <label for="edit-size-1">1: 小柄</label>
                    <input type="radio" id="edit-size-2" name="edit-birthSize" value="2">
                    <label for="edit-size-2">2: やや小柄</label>
                    <input type="radio" id="edit-size-3" name="edit-birthSize" value="3">
                    <label for="edit-size-3">3: 標準</label>
                    <input type="radio" id="edit-size-4" name="edit-birthSize" value="4">
                    <label for="edit-size-4">4: やや大柄</label>
                    <input type="radio" id="edit-size-5" name="edit-size" value="5">
                    <label for="edit-size-5">5: 大柄</label>
                </div>
            </div>
            <div class="form-group" id="edit-birthWeight-group">
                <label for="edit-birthWeight">出生時体重 (kg)</label>
                <input type="number" id="edit-birthWeight" step="0.1" min="0">
            </div>
            <div class="form-group" id="edit-birthMemo-group">
                <label for="edit-birthMemo">出生時メモ</label>
                <textarea id="edit-birthMemo" rows="3"></textarea>
            </div>
            <button class="button" onclick="saveEditedField()">保存</button>
        </div>
    </div>

    <div id="addHealthRecordModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeAddHealthRecordModal()">&times;</span>
            <h2>健康記録を追加</h2>
            <div class="form-group">
                <label for="healthRecordDate">日付</label>
                <input type="date" id="healthRecordDate" required>
            </div>
            <div class="form-group">
                <label for="healthTemperature">体温 (°C)</label>
                <input type="number" id="healthTemperature" step="0.1" placeholder="--.-" min="37.0" max="42.0">
            </div>
            <div class="form-group">
                <label for="healthSymptom">症状</label>
                <select id="healthSymptom">
                    <option value="なし">なし</option>
                    <option value="下痢">下痢</option>
                    <option value="肺炎">肺炎</option>
                    <option value="咳">咳</option>
                    <option value="食欲不振">食欲不振</option>
                    <option value="発熱">発熱</option>
                    <option value="その他">その他</option>
                </select>
            </div>
            <div class="form-group">
                <label for="healthTreatment">治療</label>
                <input type="text" id="healthTreatment">
            </div>
            <div class="form-group">
                <label for="healthVet">獣医</label>
                <input type="text" id="healthVet">
            </div>
            <div class="form-group">
                <label for="healthMemo">メモ</label>
                <textarea id="healthMemo" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="isTreating">治療中</label>
                <input type="checkbox" id="isTreating">
            </div>
            <button class="button" onclick="addHealthRecord()">記録を追加</button>
        </div>
    </div>

    <div id="recordSaleModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeRecordSaleModal()">&times;</span>
            <h2>出荷情報を登録</h2>
            <div class="form-group">
                <label for="saleDate">出荷日</label>
                <input type="date" id="saleDate" required>
            </div>
            <div class="form-group">
                <label for="salePrice">販売価格 (円)</label>
                <input type="number" id="salePrice" min="0" required>
            </div>
            <div class="form-group">
                <label for="saleMemo">出荷メモ</label>
                <textarea id="saleMemo" rows="3"></textarea>
            </div>
            <button class="button" onclick="recordSale()">出荷情報を保存</button>
        </div>
    </div>

    <div id="vaccineRecordModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeVaccineRecordModal()">&times;</span>
            <h2>ワクチン接種を記録</h2>
            <div id="vaccineInputs">
                </div>
            <button class="button" onclick="saveVaccineRecords()">保存</button>
        </div>
    </div>

    <div id="settingsPage" class="page">
        <h1>設定</h1>
        <div class="card">
            <h2>一般設定</h2>
            <div class="form-group">
                <label for="castration-days">去勢推奨日齢</label>
                <input type="number" id="castration-days" min="1" value="90">
            </div>
            <button class="button" onclick="handleSaveSettings()">設定を保存</button>
        </div>

        <div class="card">
            <h2>ワクチン設定</h2>
            <div id="vaccineTypeSettings">
                </div>
            <div class="form-group">
                <label for="newVaccineTypeName">新しいワクチン名</label>
                <input type="text" id="newVaccineTypeName">
            </div>
            <button class="button" onclick="addVaccineType()">ワクチンタイプを追加</button>
        </div>

        <div class="card">
            <h2>データ管理</h2>
            <button class="button" onclick="exportData()">データエクスポート</button>
            <div class="form-group" style="margin-top: 15px;">
                <label for="importFile" style="display: inline-block; margin-bottom: 0;">データインポート</label>
                <input type="file" id="importFile" accept=".json" style="margin-top: 5px;">
            </div>
        </div>
    </div>

    <nav class="nav">
        <a href="#" class="nav-item active" onclick="showPage('dashboard')">
            <i class="nav-item-icon fa-home"></i>
            <span>ホーム</span>
        </a>
        <a href="#" class="nav-item" onclick="showPage('cowListPage')">
            <i class="nav-item-icon fa-list"></i>
            <span>牛一覧</span>
        </a>
        <a href="#" class="nav-item" onclick="showPage('addCowPage')">
            <i class="nav-item-icon fa-plus-circle"></i>
            <span>登録</span>
        </a>
        <a href="#" class="nav-item" onclick="showPage('healthManagementPage')">
            <i class="nav-item-icon fa-heartbeat"></i>
            <span>健康</span>
        </a>
        <a href="#" class="nav-item" onclick="showPage('settingsPage')">
            <i class="nav-item-icon fa-cog"></i>
            <span>設定</span>
        </a>
    </nav>

    <script>
        // State management
        let state = {
            cows: [],
            vaccineTypes: [],
            settings: {
                castrationDays: 90
            }
        };
        let currentCowId = null; // Used for detail/edit modals

        // --- Utility Functions ---
        function saveData() {
            localStorage.setItem('calfNoteState', JSON.stringify(state));
        }

        function loadData() {
            const storedState = localStorage.getItem('calfNoteState');
            if (storedState) {
                state = JSON.parse(storedState);
                // データの整合性チェックやデフォルト値の設定（新しいプロパティが追加された場合など）
                if (!state.settings) {
                    state.settings = { castrationDays: 90 };
                }
                if (!state.vaccineTypes) {
                    state.vaccineTypes = [];
                }
                // 各牛の健康記録に isTreating がない場合の初期化
                state.cows.forEach(cow => {
                    if (cow.healthRecords) {
                        cow.healthRecords.forEach(record => {
                            if (record.isTreating === undefined) {
                                record.isTreating = false;
                            }
                        });
                    }
                    if (cow.vaccineEvents === undefined) {
                        cow.vaccineEvents = [];
                    }
                });
            }
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');

            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.nav-item[onclick="showPage('${pageId}')"]`).classList.add('active');

            // ページ表示時のレンダリング
            if (pageId === 'dashboardPage') {
                renderDashboard();
            } else if (pageId === 'cowListPage') {
                renderCowList();
            } else if (pageId === 'healthManagementPage') {
                renderHealthManagementList();
            } else if (pageId === 'settingsPage') {
                renderSettingsPage();
            } else if (pageId === 'addCowPage') {
                // 新規登録ページでは特に初期化は不要だが、フォームをクリアしても良い
                document.getElementById('newCowForm').reset();
                document.getElementById('id-error-message').classList.remove('active');
            }
        }

        function getAge(birthDate) {
            const today = new Date();
            const birth = new Date(birthDate);
            let ageMonths = (today.getFullYear() - birth.getFullYear()) * 12;
            ageMonths -= birth.getMonth();
            ageMonths += today.getMonth();
            if (today.getDate() < birth.getDate()) {
                ageMonths--;
            }
            return ageMonths >= 0 ? ageMonths : 0;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        function getSizeDescription(size) {
            switch(size) {
                case '1': return '小柄';
                case '2': return 'やや小柄';
                case '3': return '標準';
                case '4': return 'やや大柄';
                case '5': return '大柄';
                default: return '';
            }
        }

        // --- Dashboard Functions ---
        function renderDashboard() {
            const totalCows = state.cows.length;
            const maleCows = state.cows.filter(cow => cow.sex === 'オス').length;
            const femaleCows = state.cows.filter(cow => cow.sex === 'メス').length;
            const totalAgeMonths = state.cows.reduce((sum, cow) => sum + getAge(cow.birthDate), 0);
            const averageAge = totalCows > 0 ? (totalAgeMonths / totalCows).toFixed(1) : 0;

            document.getElementById('totalCows').textContent = totalCows;
            document.getElementById('maleCows').textContent = maleCows;
            document.getElementById('femaleCows').textContent = femaleCows;
            document.getElementById('averageAge').textContent = averageAge;

            renderToDoList();
            renderSaleSchedule();
        }

        function renderToDoList() {
            const todoListDiv = document.getElementById('todoList');
            todoListDiv.innerHTML = '';

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // 治療中の牛
            const treatingCows = state.cows.filter(cow =>
                cow.healthRecords && cow.healthRecords.some(record => record.isTreating)
            );
            if (treatingCows.length > 0) {
                const categoryTitle = document.createElement('div');
                categoryTitle.className = 'todo-category-title';
                categoryTitle.innerHTML = '<i class="fa-solid fa-syringe"></i> 治療中の牛';
                todoListDiv.appendChild(categoryTitle);
                treatingCows.forEach(cow => {
                    const listItem = document.createElement('div');
                    listItem.className = 'list-item todo-urgent';
                    listItem.innerHTML = `
                        <div class="list-item-content">
                            <div class="list-item-title">${cow.name} (${getAge(cow.birthDate)}ヶ月)</div>
                            <div class="list-item-meta">治療中の記録があります</div>
                        </div>
                        <div class="list-item-actions">
                            <button class="button-small" onclick="openCowDetailModal('${cow.id}')">詳細</button>
                        </div>
                    `;
                    todoListDiv.appendChild(listItem);
                });
            }

            // 去勢推奨日齢の牛
            const castrationTargetCows = state.cows.filter(cow =>
                cow.sex === 'オス' && cow.castrated === false && getAge(cow.birthDate) >= state.settings.castrationDays
            );
            if (castrationTargetCows.length > 0) {
                const categoryTitle = document.createElement('div');
                categoryTitle.className = 'todo-category-title';
                categoryTitle.innerHTML = '<i class="fa-solid fa-cut"></i> 去勢推奨日齢の牛';
                todoListDiv.appendChild(categoryTitle);
                castrationTargetCows.forEach(cow => {
                    const listItem = document.createElement('div');
                    listItem.className = 'list-item todo-warning';
                    listItem.innerHTML = `
                        <div class="list-item-content">
                            <div class="list-item-title">${cow.name} (${getAge(cow.birthDate)}ヶ月)</div>
                            <div class="list-item-meta">去勢推奨日齢を過ぎています</div>
                        </div>
                        <div class="list-item-actions">
                            <button class="button-small" onclick="openCowDetailModal('${cow.id}')">詳細</button>
                        </div>
                    `;
                    todoListDiv.appendChild(listItem);
                });
            }

            // ワクチン接種時期が近い牛 (簡易版、詳細なロジックは別途考慮)
            const vaccineSoonCows = state.cows.filter(cow => {
                // 例: 生後2ヶ月で初期ワクチン、6ヶ月で追加ワクチンなど、具体的な推奨時期があれば
                // ここでは簡略化のため、ワクチン履歴が空の牛を対象とします。
                return cow.vaccineEvents && cow.vaccineEvents.length === 0 && getAge(cow.birthDate) >= 1; // 生後1ヶ月以上でワクチン履歴がない
            });
            if (vaccineSoonCows.length > 0) {
                const categoryTitle = document.createElement('div');
                categoryTitle.className = 'todo-category-title';
                categoryTitle.innerHTML = '<i class="fa-solid fa-bell"></i> ワクチン接種推奨の牛';
                todoListDiv.appendChild(categoryTitle);
                vaccineSoonCows.forEach(cow => {
                    const listItem = document.createElement('div');
                    listItem.className = 'list-item todo-warning';
                    listItem.innerHTML = `
                        <div class="list-item-content">
                            <div class="list-item-title">${cow.name} (${getAge(cow.birthDate)}ヶ月)</div>
                            <div class="list-item-meta">ワクチン接種を検討してください</div>
                        </div>
                        <div class="list-item-actions">
                            <button class="button-small" onclick="openCowDetailModal('${cow.id}')">詳細</button>
                        </div>
                    `;
                    todoListDiv.appendChild(listItem);
                });
            }


            if (todoListDiv.children.length === 0) {
                todoListDiv.innerHTML = '<p style="text-align: center; color: #666;">現在、ToDoはありません。</p>';
            }
        }

        function renderSaleSchedule() {
            const saleScheduleListDiv = document.getElementById('saleScheduleList');
            saleScheduleListDiv.innerHTML = '';

            const soldCows = state.cows.filter(cow => cow.saleStatus === '出荷済み').sort((a, b) => {
                return new Date(a.saleDate) - new Date(b.saleDate);
            });

            if (soldCows.length === 0) {
                saleScheduleListDiv.innerHTML = '<p style="text-align: center; color: #666;">出荷予定の牛はいません。</p>';
                return;
            }

            let currentMonth = '';
            let monthContainer;

            soldCows.forEach(cow => {
                const saleDate = new Date(cow.saleDate);
                const monthName = saleDate.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long' });

                if (monthName !== currentMonth) {
                    currentMonth = monthName;
                    monthContainer = document.createElement('div');
                    monthContainer.className = 'card'; // 月ごとのカード
                    monthContainer.style.marginTop = '15px'; // 見た目を整える
                    monthContainer.style.marginBottom = '15px';
                    monthContainer.innerHTML = `<h3 class="sale-month-header">${monthName}</h3>`;
                    saleScheduleListDiv.appendChild(monthContainer);
                }

                const listItem = document.createElement('div');
                listItem.className = 'list-item';
                listItem.innerHTML = `
                    <div class="list-item-content">
                        <div class="list-item-title">${cow.name} (${getAge(cow.birthDate)}ヶ月)</div>
                        <div class="list-item-meta">出荷日: ${formatDate(cow.saleDate)} / 価格: ${cow.salePrice ? cow.salePrice.toLocaleString() + '円' : '未設定'}</div>
                    </div>
                    <div class="list-item-actions">
                        <button class="button-small" onclick="openCowDetailModal('${cow.id}')">詳細</button>
                    </div>
                `;
                monthContainer.appendChild(listItem);
            });
        }


        // --- Cow List Functions ---
        function renderCowList() {
            const cowListDiv = document.getElementById('cowList');
            cowListDiv.innerHTML = '';
            const searchTerm = document.getElementById('cowSearchInput').value.toLowerCase();

            const filteredCows = state.cows.filter(cow =>
                cow.name.toLowerCase().includes(searchTerm) ||
                (cow.individualId && cow.individualId.toLowerCase().includes(searchTerm)) ||
                (cow.motherId && cow.motherId.toLowerCase().includes(searchTerm))
            ).sort((a, b) => new Date(a.birthDate) - new Date(b.birthDate)); // 生年月日順にソート

            if (filteredCows.length === 0) {
                cowListDiv.innerHTML = '<p style="text-align: center; color: #666;">牛が見つかりません。</p>';
                return;
            }

            filteredCows.forEach(cow => {
                const listItem = document.createElement('div');
                listItem.className = 'list-item';
                listItem.innerHTML = `
                    <div class="list-item-content">
                        <div class="list-item-title">${cow.name} (${cow.sex}, ${getAge(cow.birthDate)}ヶ月)</div>
                        <div class="list-item-meta">ID: ${cow.individualId || cow.motherId || '未設定'} / 生年月日: ${formatDate(cow.birthDate)}</div>
                    </div>
                    <div class="list-item-actions">
                        <button class="button-small" onclick="openCowDetailModal('${cow.id}')">詳細</button>
                    </div>
                `;
                cowListDiv.appendChild(listItem);
            });
        }

        document.getElementById('cowSearchInput').addEventListener('input', renderCowList);

        // --- Add New Cow Functions ---
        function handleNewCowSubmit(event) {
            event.preventDefault();
            const idErrorMessage = document.getElementById('id-error-message');
            idErrorMessage.classList.remove('active'); // エラーメッセージを一旦非表示

            const cowName = document.getElementById('cowName').value.trim();
            const individualId = document.getElementById('individualId').value.trim();
            const motherId = document.getElementById('motherId').value.trim();
            const birthDate = document.getElementById('birthDate').value;
            const sex = document.querySelector('input[name="sex"]:checked')?.value;
            const birthSize = document.querySelector('input[name="birthSize"]:checked')?.value || null;
            const birthWeight = parseFloat(document.getElementById('birthWeight').value) || null;
            const birthMemo = document.getElementById('birthMemo').value.trim();

            if (!individualId && !motherId) {
                idErrorMessage.classList.add('active'); // エラーメッセージを表示
                return;
            }

            const newCow = {
                id: Date.now().toString(),
                name: cowName,
                individualId: individualId,
                motherId: motherId,
                birthDate: birthDate,
                sex: sex,
                birthSize: birthSize,
                birthWeight: birthWeight,
                birthMemo: birthMemo,
                castrated: false,
                saleStatus: '飼養中',
                saleDate: null,
                salePrice: null,
                saleMemo: null,
                healthRecords: [],
                vaccineEvents: []
            };

            state.cows.push(newCow);
            saveData();
            alert('子牛が登録されました！');
            document.getElementById('newCowForm').reset();
            document.getElementById('birthDate').valueAsDate = new Date(); // 生年月日を今日の日付に戻す
            showPage('cowListPage');
        }
        document.getElementById('newCowForm').addEventListener('submit', handleNewCowSubmit);
        document.getElementById('birthDate').valueAsDate = new Date(); // 初期値を今日の日付に設定

        // --- Health Management Functions ---
        function renderHealthManagementList() {
            const healthCowListDiv = document.getElementById('healthCowList');
            healthCowListDiv.innerHTML = '';
            const searchTerm = document.getElementById('healthSearchInput').value.toLowerCase();

            const filteredCows = state.cows.filter(cow =>
                cow.name.toLowerCase().includes(searchTerm) ||
                (cow.individualId && cow.individualId.toLowerCase().includes(searchTerm)) ||
                (cow.motherId && cow.motherId.toLowerCase().includes(searchTerm))
            ).sort((a, b) => new Date(a.birthDate) - new Date(b.birthDate));

            if (filteredCows.length === 0) {
                healthCowListDiv.innerHTML = '<p style="text-align: center; color: #666;">牛が見つかりません。</p>';
                return;
            }

            filteredCows.forEach(cow => {
                const listItem = document.createElement('div');
                listItem.className = 'list-item';
                const treatingStatus = cow.healthRecords && cow.healthRecords.some(record => record.isTreating) ?
                    '<span style="color: var(--danger-color); font-weight: bold;">治療中</span>' :
                    '<span style="color: var(--success-color);">良好</span>';
                listItem.innerHTML = `
                    <div class="list-item-content">
                        <div class="list-item-title">${cow.name} (${cow.sex}, ${getAge(cow.birthDate)}ヶ月)</div>
                        <div class="list-item-meta">健康状態: ${treatingStatus}</div>
                    </div>
                    <div class="list-item-actions">
                        <button class="button-small" onclick="openCowDetailModal('${cow.id}')">詳細</button>
                    </div>
                `;
                healthCowListDiv.appendChild(listItem);
            });
        }
        document.getElementById('healthSearchInput').addEventListener('input', renderHealthManagementList);

        // --- Cow Detail Modal Functions ---
        function openCowDetailModal(cowId) {
            currentCowId = cowId;
            const cow = state.cows.find(c => c.id === cowId);
            if (!cow) return;

            document.getElementById('detailCowName').textContent = cow.name;
            document.getElementById('view-individualId').textContent = cow.individualId || '未設定';
            document.getElementById('view-motherId').textContent = cow.motherId || '未設定';
            document.getElementById('view-birthDate').textContent = formatDate(cow.birthDate);
            document.getElementById('view-age').textContent = `${getAge(cow.birthDate)}ヶ月`;
            document.getElementById('view-sex').textContent = cow.sex;
            document.getElementById('view-birth-size').textContent = cow.birthSize ? `${cow.birthSize} / 5 (${getSizeDescription(cow.birthSize)})` : '未設定';
            document.getElementById('view-birthWeight').textContent = cow.birthWeight !== null ? cow.birthWeight : '未設定';
            document.getElementById('view-birthMemo').textContent = cow.birthMemo || 'なし';

            document.getElementById('view-castrationStatus').textContent = cow.castrated ? '去勢済み' : '未去勢';
            document.getElementById('castrateButton').style.display = cow.castrated ? 'none' : 'inline-block';
            document.getElementById('uncastrateButton').style.display = cow.castrated ? 'inline-block' : 'none';

            document.getElementById('view-saleStatus').textContent = cow.saleStatus;
            const saleInfoDiv = document.getElementById('saleInfo');
            const recordSaleButton = document.getElementById('recordSaleButton');

            if (cow.saleStatus === '出荷済み') {
                saleInfoDiv.classList.remove('hidden');
                document.getElementById('view-saleDate').textContent = formatDate(cow.saleDate);
                document.getElementById('view-salePrice').textContent = cow.salePrice ? cow.salePrice.toLocaleString() : '未設定';
                document.getElementById('view-saleMemo').textContent = cow.saleMemo || 'なし';
                recordSaleButton.style.display = 'none';
            } else {
                saleInfoDiv.classList.add('hidden');
                recordSaleButton.style.display = 'block';
            }

            renderHealthRecordsList(cowId);
            renderVaccineHistoryList(cowId);

            document.getElementById('cowDetailModal').style.display = 'flex';
        }

        function closeCowDetailModal() {
            document.getElementById('cowDetailModal').style.display = 'none';
            currentCowId = null;
            showPage(document.querySelector('.nav-item.active').onclick.toString().split("'")[1]); // 元のページに戻る
        }

        function deleteCow() {
            if (confirm('この子牛のデータを完全に削除しますか？この操作は元に戻せません。')) {
                state.cows = state.cows.filter(cow => cow.id !== currentCowId);
                saveData();
                alert('子牛が削除されました。');
                closeCowDetailModal();
                showPage('cowListPage');
            }
        }

        function updateCastrationStatus() {
            const cow = state.cows.find(c => c.id === currentCowId);
            if (cow) {
                cow.castrated = true;
                saveData();
                alert('去勢済みに更新しました。');
                openCowDetailModal(currentCowId); // 詳細を再レンダリング
            }
        }

        function revertCastrationStatus() {
            const cow = state.cows.find(c => c.id === currentCowId);
            if (cow) {
                if (confirm('去勢ステータスを「未去勢」に戻しますか？')) {
                    cow.castrated = false;
                    saveData();
                    alert('去勢ステータスを未去勢に戻しました。');
                    openCowDetailModal(currentCowId); // 詳細を再レンダリング
                }
            }
        }

        // --- Edit Field Modal Functions ---
        let currentEditField = null; // どの項目を編集しているか

        function openEditModal(field) {
            currentEditField = field;
            const cow = state.cows.find(c => c.id === currentCowId);
            if (!cow) return;

            document.querySelectorAll('#editFieldModal .form-group').forEach(group => group.style.display = 'none');
            document.getElementById('edit-id-error-message').classList.remove('active'); // エラーメッセージを非表示に

            let value;
            let title;

            switch (field) {
                case 'individualId':
                    title = '個体識別番号を編集';
                    value = cow.individualId;
                    document.getElementById('edit-individualId-group').style.display = 'block';
                    document.getElementById('edit-individualId').value = value;
                    document.getElementById('edit-motherId-group').style.display = 'block'; // 関連する母牛番号も表示
                    document.getElementById('edit-motherId').value = cow.motherId;
                    break;
                case 'motherId':
                    title = '母牛番号を編集';
                    value = cow.motherId;
                    document.getElementById('edit-motherId-group').style.display = 'block';
                    document.getElementById('edit-motherId').value = value;
                    document.getElementById('edit-individualId-group').style.display = 'block'; // 関連する個体識別番号も表示
                    document.getElementById('edit-individualId').value = cow.individualId;
                    break;
                case 'birthDate':
                    title = '生年月日を編集';
                    value = cow.birthDate;
                    document.getElementById('edit-birthDate-group').style.display = 'block';
                    document.getElementById('edit-birthDate').value = value;
                    break;
                case 'sex':
                    title = '性別を編集';
                    value = cow.sex;
                    document.getElementById('edit-sex-group').style.display = 'block';
                    document.getElementById(value === 'オス' ? 'edit-sexMale' : 'edit-sexFemale').checked = true;
                    break;
                case 'birthSize':
                    title = '出生時サイズを編集';
                    value = cow.birthSize;
                    document.getElementById('edit-birth-size-group').style.display = 'block';
                    if (value) document.getElementById(`edit-size-${value}`).checked = true;
                    break;
                case 'birthWeight':
                    title = '出生時体重を編集';
                    value = cow.birthWeight;
                    document.getElementById('edit-birthWeight-group').style.display = 'block';
                    document.getElementById('edit-birthWeight').value = value;
                    break;
                case 'birthMemo':
                    title = '出生時メモを編集';
                    value = cow.birthMemo;
                    document.getElementById('edit-birthMemo-group').style.display = 'block';
                    document.getElementById('edit-birthMemo').value = value;
                    break;
            }
            document.getElementById('editModalTitle').textContent = title;
            document.getElementById('editFieldModal').style.display = 'flex';
        }

        function closeEditModal() {
            document.getElementById('editFieldModal').style.display = 'none';
            currentEditField = null;
        }

        function saveEditedField() {
            const cow = state.cows.find(c => c.id === currentCowId);
            if (!cow) return;

            let newValue;
            let isValid = true;
            const editIdErrorMessage = document.getElementById('edit-id-error-message');

            switch (currentEditField) {
                case 'individualId':
                case 'motherId':
                    const newIndividualId = document.getElementById('edit-individualId').value.trim();
                    const newMotherId = document.getElementById('edit-motherId').value.trim();
                    if (!newIndividualId && !newMotherId) {
                        editIdErrorMessage.classList.add('active');
                        isValid = false;
                    } else {
                        cow.individualId = newIndividualId;
                        cow.motherId = newMotherId;
                    }
                    break;
                case 'birthDate':
                    newValue = document.getElementById('edit-birthDate').value;
                    cow.birthDate = newValue;
                    break;
                case 'sex':
                    newValue = document.querySelector('input[name="edit-sex"]:checked')?.value;
                    cow.sex = newValue;
                    break;
                case 'birthSize':
                    newValue = document.querySelector('input[name="edit-birthSize"]:checked')?.value || null;
                    cow.birthSize = newValue;
                    break;
                case 'birthWeight':
                    newValue = parseFloat(document.getElementById('edit-birthWeight').value) || null;
                    cow.birthWeight = newValue;
                    break;
                case 'birthMemo':
                    newValue = document.getElementById('edit-birthMemo').value.trim();
                    cow.birthMemo = newValue;
                    break;
            }

            if (isValid) {
                saveData();
                alert('情報を保存しました。');
                closeEditModal();
                openCowDetailModal(currentCowId); // 詳細を再レンダリング
            }
        }

        // --- Health Record Functions ---
        function renderHealthRecordsList(cowId) {
            const healthRecordsListDiv = document.getElementById('healthRecordsList');
            healthRecordsListDiv.innerHTML = '';
            const cow = state.cows.find(c => c.id === cowId);
            if (!cow || !cow.healthRecords || cow.healthRecords.length === 0) {
                healthRecordsListDiv.innerHTML = '<p style="text-align: center; color: #666;">健康記録はありません。</p>';
                return;
            }

            cow.healthRecords.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(record => {
                const listItem = document.createElement('div');
                listItem.className = 'list-item';
                const treatingText = record.isTreating ? '<span style="color: var(--danger-color); margin-left: 10px;">(治療中)</span>' : '';
                listItem.innerHTML = `
                    <div class="list-item-content">
                        <div class="list-item-title">${formatDate(record.date)} - ${record.symptom} ${treatingText}</div>
                        <div class="list-item-meta">体温: ${record.temperature !== null ? record.temperature + '°C' : '未記録'} / 治療: ${record.treatment || 'なし'} / 獣医: ${record.vet || 'なし'}</div>
                        <div class="list-item-meta">メモ: ${record.memo || 'なし'}</div>
                    </div>
                    <div class="list-item-actions">
                        <button class="button-small button-danger" onclick="deleteHealthRecord('${cow.id}', '${record.id}')">削除</button>
                    </div>
                `;
                healthRecordsListDiv.appendChild(listItem);
            });
        }

        function openAddHealthRecordModal() {
            document.getElementById('addHealthRecordModal').style.display = 'flex';
            document.getElementById('healthRecordDate').valueAsDate = new Date(); // 今日の日付をセット
            document.getElementById('healthTemperature').value = '';
            document.getElementById('healthSymptom').value = 'なし';
            document.getElementById('healthTreatment').value = '';
            document.getElementById('healthVet').value = '';
            document.getElementById('healthMemo').value = '';
            document.getElementById('isTreating').checked = false;
        }

        function closeAddHealthRecordModal() {
            document.getElementById('addHealthRecordModal').style.display = 'none';
        }

        function addHealthRecord() {
            const cow = state.cows.find(c => c.id === currentCowId);
            if (!cow) return;

            const date = document.getElementById('healthRecordDate').value;
            const temperature = parseFloat(document.getElementById('healthTemperature').value) || null;
            const symptom = document.getElementById('healthSymptom').value;
            const treatment = document.getElementById('healthTreatment').value.trim();
            const vet = document.getElementById('healthVet').value.trim();
            const memo = document.getElementById('healthMemo').value.trim();
            const isTreating = document.getElementById('isTreating').checked;

            if (!date) {
                alert('日付は必須です。');
                return;
            }

            const newRecord = {
                id: Date.now().toString(),
                date: date,
                temperature: temperature,
                symptom: symptom,
                treatment: treatment,
                vet: vet,
                memo: memo,
                isTreating: isTreating
            };

            cow.healthRecords.push(newRecord);
            saveData();
            alert('健康記録を追加しました。');
            closeAddHealthRecordModal();
            renderHealthRecordsList(currentCowId); // リストを再レンダリング
            openCowDetailModal(currentCowId); // 詳細も再レンダリングして治療中ステータスを更新
        }

        function deleteHealthRecord(cowId, recordId) {
            if (confirm('この健康記録を削除しますか？')) {
                const cow = state.cows.find(c => c.id === cowId);
                if (cow) {
                    cow.healthRecords = cow.healthRecords.filter(record => record.id !== recordId);
                    saveData();
                    alert('健康記録を削除しました。');
                    renderHealthRecordsList(cowId);
                    openCowDetailModal(currentCowId); // 詳細も再レンダリングして治療中ステータスを更新
                }
            }
        }

        // --- Sale Record Functions ---
        function openRecordSaleModal() {
            document.getElementById('recordSaleModal').style.display = 'flex';
            document.getElementById('saleDate').valueAsDate = new Date();
            document.getElementById('salePrice').value = '';
            document.getElementById('saleMemo').value = '';
        }

        function closeRecordSaleModal() {
            document.getElementById('recordSaleModal').style.display = 'none';
        }

        function recordSale() {
            const cow = state.cows.find(c => c.id === currentCowId);
            if (!cow) return;

            const saleDate = document.getElementById('saleDate').value;
            const salePrice = parseInt(document.getElementById('salePrice').value) || null;
            const saleMemo = document.getElementById('saleMemo').value.trim();

            if (!saleDate || salePrice === null) {
                alert('出荷日と販売価格は必須です。');
                return;
            }

            cow.saleStatus = '出荷済み';
            cow.saleDate = saleDate;
            cow.salePrice = salePrice;
            cow.saleMemo = saleMemo;
            saveData();
            alert('出荷情報を保存しました。');
            closeRecordSaleModal();
            openCowDetailModal(currentCowId); // 詳細を再レンダリング
        }

        // --- Vaccine Functions ---
        function renderVaccineHistoryList(cowId) {
            const vaccineHistoryListDiv = document.getElementById('vaccineHistoryList');
            vaccineHistoryListDiv.innerHTML = '';
            const cow = state.cows.find(c => c.id === cowId);
            if (!cow || !cow.vaccineEvents || cow.vaccineEvents.length === 0) {
                vaccineHistoryListDiv.innerHTML = '<p style="text-align: center; color: #666;">ワクチン接種履歴はありません。</p>';
                return;
            }

            cow.vaccineEvents.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(event => {
                const vaccineType = state.vaccineTypes.find(vt => vt.id === event.vaccineTypeId);
                const vaccineName = vaccineType ? vaccineType.name : '不明なワクチン';
                const listItem = document.createElement('div');
                listItem.className = 'list-item';
                listItem.innerHTML = `
                    <div class="list-item-content">
                        <div class="list-item-title">${formatDate(event.date)} - ${vaccineName}</div>
                        <div class="list-item-meta">接種量: ${event.dose || '未記録'} / 獣医: ${event.vet || '未記録'}</div>
                    </div>
                    <div class="list-item-actions">
                        <button class="button-small button-danger" onclick="deleteVaccineEvent('${cow.id}', '${event.id}')">削除</button>
                    </div>
                `;
                vaccineHistoryListDiv.appendChild(listItem);
            });
        }

        function openVaccineRecordModal() {
            const vaccineInputsDiv = document.getElementById('vaccineInputs');
            vaccineInputsDiv.innerHTML = '';

            state.vaccineTypes.forEach(type => {
                const div = document.createElement('div');
                div.className = 'form-group';
                div.innerHTML = `
                    <label for="vaccine-${type.id}">${type.name}</label>
                    <input type="date" id="vaccine-${type.id}-date" class="vaccine-date" data-vaccine-type-id="${type.id}">
                    <input type="text" id="vaccine-${type.id}-dose" class="vaccine-dose" placeholder="接種量 (mlなど)">
                    <input type="text" id="vaccine-${type.id}-vet" class="vaccine-vet" placeholder="獣医名">
                `;
                vaccineInputsDiv.appendChild(div);
            });

            if (state.vaccineTypes.length === 0) {
                vaccineInputsDiv.innerHTML = '<p style="text-align: center; color: #666;">設定からワクチンタイプを追加してください。</p>';
            }

            document.getElementById('vaccineRecordModal').style.display = 'flex';
        }

        function closeVaccineRecordModal() {
            document.getElementById('vaccineRecordModal').style.display = 'none';
        }

        function saveVaccineRecords() {
            const cow = state.cows.find(c => c.id === currentCowId);
            if (!cow) return;

            const newVaccineEvents = cow.vaccineEvents ? [...cow.vaccineEvents] : [];

            state.vaccineTypes.forEach(type => {
                const dateInput = document.getElementById(`vaccine-${type.id}-date`);
                const doseInput = document.getElementById(`vaccine-${type.id}-dose`);
                const vetInput = document.getElementById(`vaccine-${type.id}-vet`);

                if (dateInput && dateInput.value) {
                    // 同じワクチンタイプと日付の既存イベントを更新または新規追加
                    const existingIndex = newVaccineEvents.findIndex(e => e.vaccineTypeId === type.id && e.date === dateInput.value);
                    if (existingIndex > -1) {
                        newVaccineEvents[existingIndex] = {
                            ...newVaccineEvents[existingIndex],
                            date: dateInput.value,
                            dose: doseInput.value.trim(),
                            vet: vetInput.value.trim()
                        };
                    } else {
                        newVaccineEvents.push({
                            id: Date.now().toString() + '-' + type.id, // ユニークIDを生成
                            vaccineTypeId: type.id,
                            date: dateInput.value,
                            dose: doseInput.value.trim(),
                            vet: vetInput.value.trim()
                        });
                    }
                }
            });

            cow.vaccineEvents = newVaccineEvents;
            saveData();
            alert('ワクチン接種状況を保存しました。');
            closeVaccineRecordModal();
            renderVaccineHistoryList(currentCowId);
            openCowDetailModal(currentCowId); // 詳細も再レンダリングしてTo Doリストに反映
        }

        function deleteVaccineEvent(cowId, eventId) {
            if (confirm('このワクチン接種記録を削除しますか？')) {
                const cow = state.cows.find(c => c.id === cowId);
                if (cow && cow.vaccineEvents) {
                    cow.vaccineEvents = cow.vaccineEvents.filter(event => event.id !== eventId);
                    saveData();
                    alert('ワクチン接種記録を削除しました。');
                    renderVaccineHistoryList(cowId);
                    openCowDetailModal(currentCowId);
                }
            }
        }


        // --- Settings Functions ---
        function renderSettingsPage() {
            document.getElementById('castration-days').value = state.settings.castrationDays;
            renderVaccineTypeSettings();
        }

        function renderVaccineTypeSettings() {
            const vaccineTypeSettingsDiv = document.getElementById('vaccineTypeSettings');
            vaccineTypeSettingsDiv.innerHTML = '';
            state.vaccineTypes.forEach(type => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <div class="list-item-content">
                        <div class="list-item-title">${type.name}</div>
                    </div>
                    <div class="list-item-actions">
                        <button class="button-small button-danger" onclick="deleteVaccineType('${type.id}')">削除</button>
                    </div>
                `;
                vaccineTypeSettingsDiv.appendChild(div);
            });
        }

        function addVaccineType() {
            const newTypeName = document.getElementById('newVaccineTypeName').value.trim();
            if (newTypeName && !state.vaccineTypes.some(vt => vt.name === newTypeName)) {
                state.vaccineTypes.push({ id: Date.now().toString(), name: newTypeName });
                saveData();
                document.getElementById('newVaccineTypeName').value = '';
                renderSettingsPage();
            } else if (newTypeName) {
                alert('同じ名前のワクチンタイプが既に存在します。');
            } else {
                alert('ワクチン名を入力してください。');
            }
        }

        function deleteVaccineType(vtId) {
            if (confirm('このワクチン設定を削除しますか？関連する接種履歴は削除されません。')) {
                state.vaccineTypes = state.vaccineTypes.filter(vt => vt.id !== vtId);
                saveData();
                renderSettingsPage();
            }
        }

        function handleSaveSettings() {
            state.settings.castrationDays = parseInt(document.getElementById('castration-days').value) || 90;
            saveData();
            alert('設定を保存しました。');
        }

        // --- Data Import/Export Functions ---
        function exportData() {
            const dataStr = JSON.stringify(state, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `calfnote_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (!confirm("現在のデータを上書きしてインポートします。よろしいですか？")) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedState = JSON.parse(e.target.result);
                    // 簡易的なデータ構造検証
                    if (importedState.cows && Array.isArray(importedState.cows)) {
                        state = importedState;
                        saveData();
                        alert("データのインポートが完了しました。");
                        showPage('dashboardPage');
                    } else {
                        alert("インポートされたファイルのデータ形式が正しくありません。");
                    }
                } catch (error) {
                    alert("ファイルの読み込みに失敗しました。有効なJSONファイルではありません。" + error.message);
                }
            };
            reader.readAsText(file);
        }
        document.getElementById('importFile').addEventListener('change', importData);

        // --- Service Worker (PWA) Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('Service Worker registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('Service Worker registration failed: ', registrationError);
                    });
            });
        }

        // Initial load
        loadData();
        showPage('dashboardPage'); // Start on the dashboard
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js" integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</body>
</html>